import json
import logging
import os
from typing import List

import openai
from PyPDF2 import PdfReader

PROMPT = """Ð¢Ñ‹ â€” Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚, Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽÑ‰Ð¸Ð¹ Ð·Ð° Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»Ð¸ÑÐ¾Ð² Ð² CRM. ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð° (PDF, ÑÐºÐ°Ð½ Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚) Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½ JSON ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ:
{
  "client_name": "Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚",
  "policy": {
    "policy_number": "TEST-002-ZXC",
    "insurance_type": "ÐšÐÐ¡ÐšÐž",
    "insurance_company": "Ð˜Ð½Ð³Ð¾ÑÑÑ‚Ñ€Ð°Ñ…",
    "contractor": "",
    "sales_channel": "",
    "start_date": "2025-07-01",
    "end_date": "2026-06-30",
    "vehicle_brand": "Hyundai",
    "vehicle_model": "Solaris",
    "vehicle_vin": "Z94CB41ABFR123456",
    "note": "Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· ChatGPT"
  },
  "payments": [
    {
      "amount": 2000,
      "payment_date": "2025-07-05",
      "actual_payment_date": "2025-07-05"
    }
  ]
}
ðŸ“Œ ÐžÐ‘Ð©Ð˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð
Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñƒ. ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… Ð´Ð¾Ð³Ð°Ð´Ð¾Ðº Ð¸Ð»Ð¸ Ð²Ñ‹Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ….

ÐžÐ´Ð¸Ð½ Ð¿Ð¾Ð»Ð¸Ñ = Ð¾Ð´Ð¸Ð½ JSON. Ð”Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¸Ð¼Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð¾Ð´Ð½Ð¾.

ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐ¹ Ð¿Ð¾Ð»Ð¸ÑÑ‹ Ð² Ð¾Ð´Ð¸Ð½ JSON Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸:
ÐžÐ´Ð¸Ð½ Ð¸ Ñ‚Ð¾Ñ‚ Ð¶Ðµ ÑÑ‚Ñ€Ð°Ñ…ÑƒÐµÐ¼Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚,
Ð¡Ð¾Ð²Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð¿ÐµÑ€Ð¸Ð¾Ð´ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ñ,
ÐžÐ´Ð½Ð° ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ñ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ñ.

ðŸ§  Ð¡ÐŸÐ•Ð¦Ð˜ÐÐ›Ð¬ÐÐ«Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð
note
Ð’ÑÐµÐ³Ð´Ð° "Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· ChatGPT" â€” Ð±ÐµÐ· Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹.

actual_payment_date
Ð’ÑÐµÐ³Ð´Ð° Ñ€Ð°Ð²ÐµÐ½ payment_date, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÐ²Ð½Ð¾ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½.

contractor
Ð’ÑÐµÐ³Ð´Ð° Ð¿ÑƒÑÑ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ. ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½ Ð² Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ðµ.

sales_channel
Ð•ÑÐ»Ð¸ Ð² Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ð¸ Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð² ("ÐœÐ°Ñ€ÑŒÐ¸Ð½ÑÐºÐ¸Ñ…", "Ð›ÐµÐ¶Ð½ÐµÐ²", "ÐœÑƒÐ·Ñ‹Ñ‡ÐµÐ½ÐºÐ¾") â€” ÑÑ‚Ð¾ ÐºÐ°Ð½Ð°Ð» Ð¿Ñ€Ð¾Ð´Ð°Ð¶

insurance_type
Ð•ÑÐ»Ð¸ ÑÑ‚Ñ€Ð°Ñ…ÑƒÐµÑ‚ÑÑ Ð¶Ð¸Ð·Ð½ÑŒ Ð¸ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð·Ð°ÐµÐ¼Ñ‰Ð¸ÐºÐ° Ð¿Ð¾ Ð¸Ð¿Ð¾Ñ‚ÐµÐºÐµ â€” ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ "Ð˜Ð¿Ð¾Ñ‚ÐµÐºÐ°".
Ð•ÑÐ»Ð¸ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿ Ð¿Ð¾Ð»Ð¸ÑÐ° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, "Ð–Ð¸Ð·Ð½ÑŒ" Ð¸Ð»Ð¸ "ÐšÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð°"), ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾.
ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ "ÐÐµÑÑ‡Ð°ÑÑ‚Ð½Ñ‹Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹", Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½ ÑÐ²Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ð½.

vehicle_vin
Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½ â€” Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ.
Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ â€” Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ ("").

payments
Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¾Ð±Ñ‰Ð¸Ð¹ Ð³Ñ€Ð°Ñ„Ð¸Ðº â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾.
Ð•ÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ð°ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸ â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ñ….
Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¾Ð±Ñ‰Ðµ Ð½ÐµÑ‚ Ð´Ð°Ñ‚ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ â€” ÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ = start_date.

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð°Ñ‚
Ð’ÑÐµÐ³Ð´Ð° Ð² ISO-Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ: YYYY-MM-DD.
Ð”Ð°Ñ‚Ð° Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»Ð¸ÑÐ° Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð´Ð°Ñ‚Ñ‹ Ð½Ð°Ñ‡Ð°Ð»Ð° + 1 Ð³Ð¾Ð´. Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»Ð¸Ñ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡ÐµÐ¼ Ð½Ð° 1 Ð³Ð¾Ð´, Ñ‚Ð¾ ÑÑ‚Ð°Ð²ÑŒ Ð´Ð°Ñ‚Ñƒ Ð¾ÐºÐ¾Ð½Ñ‡Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»Ð¸ÑÐ° = Ð´Ð°Ñ‚Ð° Ð½Ð°Ñ‡Ð°Ð»Ð° Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ + 1 Ð³Ð¾Ð´

ðŸ§¹ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ Ð¢Ð•ÐšÐ¡Ð¢Ð
Ð£Ð´Ð°Ð»ÑÐ¹ Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹, Ñ‚Ð°Ð±ÑƒÐ»ÑÑ†Ð¸Ð¸, Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÑ‹ ÑÑ‚Ñ€Ð¾Ðº Ð¸ Ð¼ÑƒÑÐ¾Ñ€.
Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÐµÐ¹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ñ‹ Ð¸ Ð¾Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.
ÐÐµ Ð´Ð¾Ð¿ÑƒÑÐºÐ°ÑŽÑ‚ÑÑ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ null, -, N/A, undefined Ð¸ Ñ‚.Ð¿.

ðŸ“‹ ÐŸÐžÐ Ð¯Ð”ÐžÐš ÐžÐ‘Ð ÐÐ‘ÐžÐ¢ÐšÐ˜
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»Ð¸ÑÐ¾Ð² Ð² Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ðµ.
Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ð¸ÑÐ°:
ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ð¾Ð±ÑŠÐµÐºÑ‚ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ñ, ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²ÑƒÑŽ, Ñ‚Ð¸Ð¿, Ð´Ð°Ñ‚Ñ‹.
Ð•ÑÐ»Ð¸ Ð¾Ð±ÑŠÐµÐºÑ‚, Ð´Ð°Ñ‚Ñ‹ Ð¸ ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ñ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚ â€” Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÑÐ¹ Ð½Ð¾Ð¼ÐµÑ€Ð° Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ Ð² policy_number.
Ð˜Ð½Ð°Ñ‡Ðµ â€” ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð¹ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ JSON.
Ð˜Ð·Ð²Ð»ÐµÐºÐ¸ Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚Ð¸ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ Ð¿Ð¾ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°Ð¼ Ð²Ñ‹ÑˆÐµ.
Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐ¹ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ JSON.

âœ… Ð§Ð•ÐšÐ›Ð˜Ð¡Ð¢ ÐŸÐ•Ð Ð•Ð” Ð’Ð«Ð”ÐÐ§Ð•Ð™ JSON
 note = "Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· ChatGPT"
 actual_payment_date = payment_date
 Ð’ÑÐµ Ð´Ð°Ñ‚Ñ‹ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ YYYY-MM-DD
 VIN ÑƒÐºÐ°Ð·Ð°Ð½? â†’ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½
 contractor = "" Ð²ÑÐµÐ³Ð´Ð°
 insurance_type ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½ (Ð¿Ñ€Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸)
 ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ "ÐÐµÑÑ‡Ð°ÑÑ‚Ð½Ñ‹Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹"
 ÐÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð»Ð¸ÑÐ¾Ð² Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾?
 ÐÐµÑ‚ null, -, N/A Ð¸ Ð¿Ñ€Ð¾Ñ‡ÐµÐ³Ð¾
"""

logger = logging.getLogger(__name__)


def _read_text(path: str) -> str:
    """Extract text from a PDF or text file."""
    if path.lower().endswith(".pdf"):
        try:
            reader = PdfReader(path)
            text = "\n".join(page.extract_text() or "" for page in reader.pages)
            if text:
                return text
        except Exception as e:
            logger.warning("Failed to read PDF %s: %s", path, e)
    try:
        with open(path, "r", encoding="utf-8") as f:
            return f.read()
    except Exception:
        with open(path, "rb") as f:
            return f.read().decode("utf-8", "ignore")


def process_policy_files_with_ai(paths: List[str]) -> List[dict]:
    """Send policy files to OpenAI and return parsed JSON data."""
    if not paths:
        return []

    api_key = os.getenv("OPENAI_API_KEY")
    if not api_key:
        raise ValueError("OPENAI_API_KEY is not set")

    base_url = os.getenv("OPENAI_BASE_URL")
    client = openai.OpenAI(api_key=api_key, base_url=base_url)
    results: List[dict] = []
    for path in paths:
        text = _read_text(path)
        messages = [
            {"role": "system", "content": PROMPT},
            {"role": "user", "content": text[:16000]},
        ]
        try:
            resp = client.chat.completions.create(
                model="gpt-4o",
                messages=messages,
                temperature=0,
            )
        except Exception as e:
            raise RuntimeError(f"OpenAI request failed for {path}: {e}") from e

        answer = resp.choices[0].message.content
        try:
            data = json.loads(answer)
        except Exception:
            try:
                start = answer.index("{")
                end = answer.rindex("}") + 1
                data = json.loads(answer[start:end])
            except Exception as e:
                raise ValueError(f"Failed to parse JSON for {path}: {e}") from e
        results.append(data)
    return results
