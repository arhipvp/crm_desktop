# CRM Desktop

Простое учебное CRM‑приложение на Python с использованием Peewee и PySide6. Позволяет вести базу клиентов, сделок, полисов и задач. Для работы с задачами есть отдельный Telegram‑бот. Файлы клиентов, сделок и полисов могут храниться в Google Drive.

Подробное руководство по установке зависимостей и отправке изменений см. в [CONTRIBUTING.md](CONTRIBUTING.md).

## Структура каталогов

- `database/` – модели и инициализация БД.
- `services/` – бизнес‑логика и утилиты.
- `ui/` – Qt‑интерфейс приложения.
- `telegram_bot/` – код Telegram‑бота и Dockerfile.
- `tests/` – автотесты `pytest`.
- `resources/` – стили и статические файлы.
- `utils/` – вспомогательные модули.

## Пример `.env`

```env
DATABASE_URL=sqlite:///crm.db
TG_BOT_TOKEN=000000:telegram-bot-token
ADMIN_CHAT_ID=123456789  # Telegram ID администратора для уведомлений
APPROVED_EXECUTOR_IDS=111,222  # Telegram ID разрешённых исполнителей
GOOGLE_DRIVE_LOCAL_ROOT=/path/to/drive
GOOGLE_CREDENTIALS=credentials.json
GOOGLE_ROOT_FOLDER_ID=1-hTRZ7meDTGDQezoY_ydFkmXIng3gXFm
GOOGLE_SHEETS_TASKS_ID=1AbCdEfGh  # ID таблицы задач Google Sheets
GOOGLE_SHEETS_CALCULATIONS_ID=1AbCdEfGh  # ID таблицы расчётов Google Sheets
OPENAI_API_KEY=sk-example
OPENAI_BASE_URL=https://api.openai.com/v1  # например, https://api.together.xyz/v1
OPENAI_MODEL=gpt-4o  # например, gpt-3.5-turbo
LOG_LEVEL=INFO  # уровень логирования (например, DEBUG)
DETAILED_LOGGING=0  # подробный режим логирования (DEBUG + SQL-запросы)
LOG_DIR=/path/to/logs  # каталог для файлов логов (опционально)
AI_POLICY_PROMPT=
```

### Общие переменные

- `DATABASE_URL` — строка подключения к SQLite или PostgreSQL.
- `GOOGLE_DRIVE_LOCAL_ROOT` — локальный каталог синхронизации с Google Drive.
- `GOOGLE_CREDENTIALS` — путь к JSON‑файлу сервисного аккаунта.

### Переменные OpenAI

Эти параметры включают функции `ai_consultant_service` и импорт/обработку полисов.

- **OPENAI_API_KEY** — ключ API OpenAI или совместимого сервиса.
- **OPENAI_BASE_URL** — базовый URL API (например, https://api.openai.com/v1).
- **OPENAI_MODEL** — название модели для запросов (например, gpt-4o).
- **AI_POLICY_PROMPT** — системный промпт для распознавания полисов; позволяет переопределить стандартные правила.

### Переменные Telegram и Google Drive

- **TG_BOT_TOKEN** — токен Telegram‑бота.
- **APPROVED_EXECUTOR_IDS** — список ID исполнителей, которым разрешено получать задачи.
- **GOOGLE_ROOT_FOLDER_ID** — ID корневой папки в Google Drive (см. раздел [Работа с Google Drive](#работа-с-google-drive)).
- **GOOGLE_SHEETS_TASKS_ID** и **GOOGLE_SHEETS_CALCULATIONS_ID** — идентификаторы связанных таблиц Google Sheets (см. раздел [Работа с Google Drive](#работа-с-google-drive)).

Переменная `ADMIN_CHAT_ID` задаёт Telegram‑ID администратора, которому бот отправляет уведомления.

Переменная `LOG_LEVEL` управляет уровнем логов. Допустимые значения совпадают с уровнями модуля `logging` (например, `DEBUG`, `INFO`). По умолчанию используется `INFO`.

Переменная `DETAILED_LOGGING` включает расширенный режим диагностики. Значение `1` принудительно активирует уровень `DEBUG` (значение `LOG_LEVEL` в этом случае игнорируется) и отключает фильтрацию SQL-запросов для логгера `peewee`. При значении `0` используется уровень из `LOG_LEVEL`, а фильтр SELECT-запросов остаётся включённым.

Переменная `LOG_DIR` задаёт путь к каталогу с логами. Если она не указана, используется стандартный путь `appdirs.user_log_dir` для приложения `crm_desktop`.

## Подготовка окружения

1. Создайте и активируйте виртуальное окружение:

```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
```

2. **Только для Linux:** перед установкой зависимостей выполните:

```bash
sudo apt-get update
sudo apt-get install -y libegl1 libgl1
```

Эти библиотеки необходимы для корректной работы `PySide6` и автотестов.

3. Установите зависимости:

```bash
pip install -e .
```

Все зависимости и настройки инструментов описаны в `pyproject.toml`.

4. Скопируйте `.env.example` в `.env` и укажите свои значения.

## Запуск приложения

1. Подготовьте окружение (см. раздел выше).
2. Запустите интерфейс командой `python main.py`.

После запуска откроется вкладка **Главная** со сводной статистикой. В нижней части окна отображается строка состояния с количеством записей в текущей таблице. На дашборде показываются ближайшие задачи, заканчивающиеся полисы и напоминания по сделкам. Для каждой записи выводятся основные детали: дата, короткая заметка и связанные клиент, сделка или полис. Записи кликабельны и открывают подробную карточку объекта. Дополнительно выводятся счётчики задач: сколько отправлено в Telegram, сколько сейчас в работе и сколько ожидают подтверждения.

### Расходы контрагентам

При изменении контрагента в карточке полиса открывается диалог выбора платежей. В таблице отображаются все активные платежи и статус связанных расходов типа «контрагент». Пользователь может отметить только те платежи, для которых нужно создать или обновить расход. Для выбранных позиций автоматически создаются расходы с нулевой суммой, а существующие записи получают актуальное примечание и, при наличии даты оплаты, заполняют поле даты расхода.

## Фильтрация

В таблицах можно фильтровать данные, кликая по заголовкам столбцов. При клике открывается стандартное меню с полем ввода, которое подключено к `QSortFilterProxyModel` через `setFilterKeyColumn`.

## Запуск Telegram‑бота

Бот работает только внутри Docker‑контейнера. Перед запуском
скопируйте `telegram_bot/.env.example` в `telegram_bot/.env` и
укажите значения хотя бы для переменных `DATABASE_URL` и `TG_BOT_TOKEN`.
В деталях сделки есть кнопка «Отправить задачу исполнителю». Она
создаёт новую задачу, сразу отправляет её в Telegram выбранному
исполнителю и помечает выполненной. Сообщение содержит кнопки
«Выполнить» и «Написать вопрос». Список
незавершённых задач можно получить командой `/tasks`.
В таблице задач появилась кнопка «Напомнить»,
которая возвращает выбранные задачи в очередь и
повторно отправляет уведомление исполнителю.

## Docker Compose

В репозитории есть `docker-compose.yml` для запуска PostgreSQL и бота.
Перед стартом создайте в корне файл `.env` с параметрами базы:

```env
POSTGRES_DB=crm
POSTGRES_USER=crm_user
POSTGRES_PASSWORD=crm_pass
```

`telegram_bot/.env` пример (такой же файл `.env.example` уже есть в каталоге):

```env
DATABASE_URL=postgres://crm_user:crm_pass@db:5432/crm
TG_BOT_TOKEN=000000:telegram-bot-token
APPROVED_EXECUTOR_IDS=111,222
GOOGLE_DRIVE_LOCAL_ROOT=/path/to/drive  # опционально
GOOGLE_CREDENTIALS=credentials.json     # опционально
LOG_LEVEL=INFO  # уровень логирования (например, DEBUG)
DETAILED_LOGGING=0  # подробный режим логирования (DEBUG + SQL-запросы)
LOG_DIR=/app/logs  # каталог для файлов логов внутри контейнера
```

Запустите сервисы командой:

```bash
docker-compose up -d
```

Сервис `db` использует том `db_data:/var/lib/postgresql/data`.

> ℹ️ Чтобы логи бота сохранялись на хостовой машине (монтирование `./logs:/app/logs`), оставьте значение `LOG_DIR=/app/logs` в `telegram_bot/.env`.

## Тесты

Запуск тестов выполняется командой с таймаутом:

```bash
PYTEST_TIMEOUT=120 pytest -vv
```

Дополнительные рекомендации по тестированию смотрите в [CONTRIBUTING.md](CONTRIBUTING.md).

## Работа с Google Drive

Функции загрузки и создания папок используют сервисный аккаунт Google.
Укажите путь к JSON‑файлу в переменной `GOOGLE_CREDENTIALS` и локальный
каталог синхронизации в `GOOGLE_DRIVE_LOCAL_ROOT`. Для корректной работы
необходимы библиотеки `google-api-python-client`, `google-auth` и
`google-auth-oauthlib` (уже перечислены в `pyproject.toml`).

При создании клиентов, сделок и полисов папки появляются только локально в каталоге,
указанном в `GOOGLE_DRIVE_LOCAL_ROOT`; для загрузки в Google Drive требуется ручная
синхронизация. Если при открытии папки её нет на диске, приложение предложит выбрать
каталог вручную или отменить операцию.

При необходимости синхронизируйте данные с облаком вручную либо с помощью
сторонних инструментов.

## Резервное копирование

Скрипт `backup.py` использует переменную окружения `DATABASE_URL` и
ожидает, что контейнер `crm_db` запущен. Подключение к PostgreSQL
происходит через `docker exec`, после чего файлы бэкапа
загружаются в Google Drive.

Перед запуском укажите переменные:

- `POSTGRES_USER` — имя пользователя PostgreSQL;
- `POSTGRES_DB` — имя базы данных;
- `GOOGLE_CREDENTIALS` — путь к JSON‑файлу сервисного аккаунта;
- `GOOGLE_ROOT_FOLDER_ID` — ID папки в Google Drive для бэкапов.
